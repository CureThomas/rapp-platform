<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>RAPP Platform Wiki: A-full-RAPP-Platform-service-creation-example-advanced</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="RAPP_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">RAPP Platform Wiki
   &#160;<span id="projectnumber">v0.5.5</span>
   </div>
   <div id="projectbrief">RAPP Platform is a collection of ROS nodes and back-end processes that aim to deliver ready-to-use generic services to robots</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_rapp-platform_8wiki_A-full-RAPP-Platform-service-creation-example-advanced.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">A-full-RAPP-Platform-service-creation-example-advanced </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In this example, a basic guide will be presented that will cover the basics of creating an example RAPP Platform service. We assume that you have successfully installed the RAPP Platform and run the tests, if not please see our installation guide located at</p>
<p><a href="https://github.com/rapp-project/rapp-platform/wiki/How-can-I-set-up-the-RAPP-Platform-in-my-PC%3F">https://github.com/rapp-project/rapp-platform/wiki/How-can-I-set-up-the-RAPP-Platform-in-my-PC%3F</a></p>
<p>It is addressed to the novice user and as such, experienced users may find it too detailed or need to skip over some sections. This tutorial assumes some basic ROS knowledge. Users not familiar with ROS are advised to first complete relevant ROS tutorials that can be found at</p>
<p><a href="http://wiki.ros.org/ROS/Tutorials">http://wiki.ros.org/ROS/Tutorials</a></p>
<p>By the end of the tutorial you should be able to call the service itself and obtain meaningful results. What you will learn:</p>
<ul>
<li>How to create a ROS service in the RAPP Platform and how to incorporate its launcher in the RAPP Platform launchers in order for the service to start along with the other services of the RAPP Platform</li>
<li>How to call another ROS service within your service</li>
<li>How to create a ROS test for your service</li>
<li>How to create a HOP service for the ROS service that you created. The HOP service will be exposed on the network and will allow you to call the service over an http web request.</li>
</ul>
<h2>Section 1: Creating a ROS RAPP Platform example service</h2>
<p>In this section we will cover how to create a basic ROS RAPP Platform service. Let us assume that the service we should to create takes as input two integer number, adds them together and returns the result. It also takes as input a string containing the username of a user and it returns a string containing the ontology alias of the user, by making a call to the appropriate ROS RAPP Platform service.</p>
<h3>Create a ROS Node</h3>
<p>The first thing to do is to create a new ROS Node which will be responsible for the service we want to implement. In order to create a new ROS node, navigate within the rapp-platform directory and create a new package:</p>
<p>```bash $ cd ~/rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/ $ catkin_create_pkg rapp_example_service std_msgs rospy rapp_platform_ros_communications ```</p>
<p>This command creates a new package named rapp_example_service and adds the its dependencies upon the std_msgs, rospy and rapp_platform_ros_communications packages. You can now navigate within the newly created package, and create a directory named cfg:</p>
<p>```bash $ cd ~/rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_example_service/ $ mkdir cfg $ cd cfg $ touch rapp_example_service_params.yaml $ echo 'rapp_example_service_topic: /rapp/rapp_example_service/add_two_integers' &gt;&gt; rapp_example_service_params.yaml ```</p>
<p>We declared was the name of the service within the .yaml file. Now we will navigate back into the rapp_example_service package and create the launch dir.</p>
<p>```bash $ cd ~/rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_example_service $ mkdir launch $ cd launch $ touch rapp_example_service.launch ```</p>
<p>The content of <code>rapp_example_service.launch</code> follows:</p>
<p>```xml &lt;launch&gt; &lt;node name="rapp_example_service_node" pkg="rapp_example_service" type="rapp_example_service_main.py" output="screen"&gt; &lt;rosparam file="$(find rapp_example_service)/cfg/rapp_example_service_params.yaml" command="load"&gt; &lt;/launch&gt; ```</p>
<p>This file declares the launcher of the service.</p>
<p>Now, we will create the source code files according to the coding standards of the RAPP project.</p>
<p>```bash $ cd ~/rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_example_service/src $ touch rapp_example_service_main.py ```</p>
<p>The content of <code>rapp_example_service_main.py</code> follows</p>
<p>```python #!/usr/bin/env python</p>
<p>import rospy from rapp_example_service import ExampleService</p>
<p>if <b>name</b> == "__main__": rospy.init_node('ExampleService') ExampleServicesNode = ExampleService() rospy.spin() ```</p>
<p>We have declared the main function of the ROS node and launched the ROS node with the rospy.spin() command. Now we will create the <code>rapp_example_service.py</code> below:</p>
<p>```bash $ cd ~/rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_example_service/src $ touch rapp_example_service.py ```</p>
<p>The content of <code>rapp_example_service.py</code> follows:</p>
<p>```python #!/usr/bin/env python</p>
<p>import rospy</p>
<p>from add_two_integers import AddTwoIntegers</p>
<p>from rapp_platform_ros_communications.srv import ( tutorialExampleServiceSrv, tutorialExampleServiceSrvRequest, tutorialExampleServiceSrvResponse)</p>
<p>class ExampleService: </p>
<pre class="fragment">def __init__(self):
    self.serv_topic = rospy.get_param('rapp_knowrob_wrapper_create_ontology_alias')
    if(not self.serv_topic):
        rospy.logerror("rapp_knowrob_wrapper_create_ontology_alias param not found")
    rospy.wait_for_service(self.serv_topic)

    self.serv_topic = rospy.get_param("rapp_example_service_topic")
    if(not self.serv_topic):
        rospy.logerror("rapp_example_service_topic")
    self.serv=rospy.Service(self.serv_topic, tutorialExampleServiceSrv, self.tutorialExampleServiceDataHandler)

def tutorialExampleServiceDataHandler(self,req):
    res = tutorialExampleServiceSrvResponse()
    it = AddTwoIntegers()
    res=it.addTwoIntegersFunction(req)
    return res
</pre><p> ```</p>
<p>In this file, we initially declare python dependencies, one of them is the AddTwoIntegers class which we will define in a new file next. As you can see, we have imported an srv message files that needs to be created and declared in the rapp_platform_ros_communications package. We will cover this shortly. We also imported the name of the service from the .yaml file located in the cfg folder by the rospy.get_param() command. As our service depends on the <code>rapp_knowrob_wrapper_create_ontology_alias</code> we have it wait until it is available. The return message of the service is handled by the DataHandler function we created, named tutorialExampleServiceDataHandler.</p>
<p>The last file we need to create is the <code>add_two_integers.py</code>.</p>
<p>```bash $ cd ~/rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_example_service/src $ touch add_two_integers.py ```</p>
<p>The content of <code>add_two_integers.py</code> follows:</p>
<p>```python #!/usr/bin/env python</p>
<p>import rospy from rapp_platform_ros_communications.srv import ( tutorialExampleServiceSrv, tutorialExampleServiceSrvRequest, tutorialExampleServiceSrvResponse, createOntologyAliasSrv, createOntologyAliasSrvRequest, createOntologyAliasSrvResponse)</p>
<p>class AddTwoIntegers: </p>
<pre class="fragment">def addTwoIntegersFunction(self,req):
    res = tutorialExampleServiceSrvResponse()
    res.additionResult=req.a+req.b
    res.userOntologyAlias=self.getUserOntologyAlias(req.username)
    return res

def getUserOntologyAlias(self,username):
    serv_topic = rospy.get_param('rapp_knowrob_wrapper_create_ontology_alias')
    knowrob_service = rospy.ServiceProxy(serv_topic, createOntologyAliasSrv)
    createOntologyAliasReq = createOntologyAliasSrvRequest()
    createOntologyAliasReq.username=username
    createOntologyAliasResponse = knowrob_service(createOntologyAliasReq)
    return createOntologyAliasResponse.ontology_alias
</pre><p> ```</p>
<p>In this file, initially we define the imports again and following we define the AddTwoIntegers class and within it a simple function named addTwoIntegersFunction that accepts the service requirements as input and returns the service response. We initially construct the response named res, and we assign to the addition value the addition of the parameters a and b. The function getUserOntologyAlias defined, is tasked with calling an existing RAPP Platform service, the <code>rapp_knowrob_wrapper_create_ontology_alias</code>. This service will create an ontology alias for a user in case it does not already exist, or simply return the existing one if it already exists. The argument to call the service is the user's username. In this way, by calling this existing RAPP Platform service, we obtain the userOntologyAlias of a user given his username, and we assign it to the appropriate service response variable.</p>
<h3>Create the service srv file</h3>
<p>The srv file defines what the service will accept as input and what it will return as output. These must be declared in a special file, called the service's srv file. RAPP Platform conveniently places all ROS service srv files, as well as ROS service message files in the</p>
<p>``` /rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_platform_ros_communications/ ```</p>
<p>package. Let us assume that the service we should to create takes as input two integer number, adds them together and returns the result. First we need to create the .srv file declaring the inputs and outputs of the service as shown:</p>
<p>```bash $ cd /rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_platform_ros_communications/srv $ mkdir ExampleServices $ cd ExampleServices $ touch tutorialExampleServiceSrv.srv ```</p>
<p>The content of <code>tutorialExampleServiceSrv.srv</code> follows:</p>
<p>```yaml Header header int32 a int32 b </p>
<h2>string username </h2>
<p>string userOntologyAlias int32 additionResult string error ```</p>
<p>Toe declare the .srv file in the package, open the <code>/rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_platform_ros_communications/rapp_platform_ros_communications/CMakeLists.txt</code> file and add the following line within the <code>add_service_files()</code> block,</p>
<p>``` ExampleServices/tutorialExampleServiceSrv.srv ```</p>
<p>The whole file now should look like this:</p>
<p>```cmake cmake_minimum_required(VERSION 2.8.3) project(rapp_platform_ros_communications) set(ROS_BUILD_TYPE Release)</p>
<p>find_package(catkin REQUIRED COMPONENTS message_generation message_runtime std_msgs geometry_msgs nav_msgs )</p>
<h6></h6>
<h2>Declare ROS messages, services and actions</h2>
<h6></h6>
<h2>Generate messages in the 'msg' folder</h2>
<p>add_message_files( FILES StringArrayMsg.msg CognitiveExercisePerformanceRecordsMsg.msg MailMsg.msg NewsStoryMsg.msg WeatherForecastMsg.msg ArrayCognitiveExercisePerformanceRecordsMsg.msg CognitiveExercisesMsg.msg )</p>
<h2>Generate services in the 'srv' folder</h2>
<p>add_service_files( FILES</p>
<p>/ExampleServices/tutorialExampleServiceSrv.srv</p>
<p>/CognitiveExercise/testSelectorSrv.srv /CognitiveExercise/recordUserCognitiveTestPerformanceSrv.srv /CognitiveExercise/cognitiveTestCreatorSrv.srv /CognitiveExercise/userScoresForAllCategoriesSrv.srv /CognitiveExercise/userScoreHistoryForAllCategoriesSrv.srv /CognitiveExercise/returnTestsOfTypeSubtypeDifficultySrv.srv</p>
<p>/HumanDetection/HumanDetectionRosSrv.srv</p>
<p>/CaffeWrapper/imageClassificationSrv.srv /CaffeWrapper/ontologyClassBridgeSrv.srv /CaffeWrapper/registerImageToOntologySrv.srv</p>
<p>/DbWrapper/checkIfUserExistsSrv.srv /DbWrapper/getUserOntologyAliasSrv.srv /DbWrapper/getUserLanguageSrv.srv /DbWrapper/registerUserOntologyAliasSrv.srv /DbWrapper/getUserPasswordSrv.srv /DbWrapper/getUsernameAssociatedWithApplicationTokenSrv.srv /DbWrapper/createNewPlatformUserSrv.srv /DbWrapper/createNewApplicationTokenSrv.srv /DbWrapper/checkActiveApplicationTokenSrv.srv /DbWrapper/checkActiveRobotSessionSrv.srv /DbWrapper/addStoreTokenToDeviceSrv.srv /DbWrapper/validateUserRoleSrv.srv /DbWrapper/validateExistingPlatformDeviceTokenSrv.srv /DbWrapper/removePlatformUserSrv.srv /DbWrapper/createNewCloudAgentServiceSrv.srv /DbWrapper/createNewCloudAgentSrv.srv /DbWrapper/getCloudAgentServiceTypeAndHostPortSrv.srv</p>
<p>/OntologyWrapper/createInstanceSrv.srv /OntologyWrapper/ontologySubSuperClassesOfSrv.srv /OntologyWrapper/ontologyIsSubSuperClassOfSrv.srv /OntologyWrapper/ontologyLoadDumpSrv.srv /OntologyWrapper/ontologyInstancesOfSrv.srv /OntologyWrapper/assertRetractAttributeSrv.srv /OntologyWrapper/returnUserInstancesOfClassSrv.srv /OntologyWrapper/createOntologyAliasSrv.srv /OntologyWrapper/userPerformanceCognitveTestsSrv.srv /OntologyWrapper/createCognitiveExerciseTestSrv.srv /OntologyWrapper/cognitiveTestsOfTypeSrv.srv /OntologyWrapper/recordUserPerformanceCognitiveTestsSrv.srv /OntologyWrapper/clearUserPerformanceCognitveTestsSrv.srv /OntologyWrapper/registerImageObjectToOntologySrv.srv /OntologyWrapper/retractUserOntologyAliasSrv.srv</p>
<p>/FaceDetection/FaceDetectionRosSrv.srv</p>
<p>/NewsExplorer/NewsExplorerSrv.srv /Geolocator/GeolocatorSrv.srv</p>
<p>/WeatherReporter/WeatherReporterCurrentSrv.srv /WeatherReporter/WeatherReporterForecastSrv.srv</p>
<p>/QrDetection/QrDetectionRosSrv.srv</p>
<p>/Email/SendEmailSrv.srv /Email/ReceiveEmailSrv.srv</p>
<p>/SpeechDetectionGoogleWrapper/SpeechToTextSrv.srv</p>
<p>/SpeechDetectionSphinx4Wrapper/SpeechRecognitionSphinx4Srv.srv /SpeechDetectionSphinx4Wrapper/SpeechRecognitionSphinx4ConfigureSrv.srv /SpeechDetectionSphinx4Wrapper/SpeechRecognitionSphinx4TotalSrv.srv</p>
<p>/AudioProcessing/AudioProcessingDenoiseSrv.srv /AudioProcessing/AudioProcessingSetNoiseProfileSrv.srv /AudioProcessing/AudioProcessingDetectSilenceSrv.srv /AudioProcessing/AudioProcessingTransformAudioSrv.srv</p>
<p>/TextToSpeechEspeak/TextToSpeechSrv.srv</p>
<p>/HazardDetection/LightCheckRosSrv.srv /HazardDetection/DoorCheckRosSrv.srv</p>
<p>/PathPlanning/PathPlanningRosSrv.srv /Costmap2d/Costmap2dRosSrv.srv /PathPlanning/MapServer/MapServerGetMapRosSrv.srv /PathPlanning/MapServer/MapServerUploadMapRosSrv.srv</p>
<p>/ApplicationAuthentication/UserTokenAuthenticationSrv.srv /ApplicationAuthentication/UserLoginSrv.srv /ApplicationAuthentication/AddNewUserFromStoreSrv.srv /ApplicationAuthentication/AddNewUserFromPlatformSrv.srv )</p>
<h2>Generate added messages and services with any dependencies listed here</h2>
<p>generate_messages( DEPENDENCIES std_msgs # Or other packages containing msgs geometry_msgs nav_msgs )</p>
<h6></h6>
<h2>catkin specific configuration</h2>
<h6></h6>
<h2>The catkin_package macro generates cmake config files for your package</h2>
<h2>Declare things to be passed to dependent projects</h2>
<h2>INCLUDE_DIRS: uncomment this if you package contains header files</h2>
<h2>LIBRARIES: libraries you create in this project that dependent projects also need</h2>
<h2>CATKIN_DEPENDS: catkin_packages dependent projects also need</h2>
<h2>DEPENDS: system dependencies of this project that dependent projects also need</h2>
<p>catkin_package( </p>
<h1>INCLUDE_DIRS include</h1>
<h1>LIBRARIES rapp_platform_ros_communications</h1>
<h1>CATKIN_DEPENDS other_catkin_pkg</h1>
<p>CATKIN_DEPENDS message_generation message_runtime std_msgs geometry_msgs ) ```</p>
<p>This line will declare the srv file we created and stage it to be compiled.</p>
<p>Now we need to recompile the package. We will navigate to the root RAPP Platform catkin workspace directory and compile the code as shown below:</p>
<p>```bash $ cd ~/rapp_platform/rapp-platform-catkin-ws/ $ catkin_make &ndash;pkg rapp_platform_ros_communications ```</p>
<p>this will recompile only the specific package. Sometimes it is preferable to recompile the whole project, in that case please delete the folders build and devel and compile the whole project, as shown below:</p>
<p>```bash $ cd ~/rapp_platform/rapp-platform-catkin-ws/ $ rm -rf ./build ./devel $ catkin_make ```</p>
<h3>Launch and manually test the service</h3>
<p>In order to test that our ROS service works:</p>
<p>```bash $ cd ~/rapp_platform/rapp-platform-catkin-ws/ $ roslaunch rapp_example_service rapp_example_service.launch ```</p>
<p>With our service launched, use a different terminal and type:</p>
<p>```bash $ rosservice call /rapp/rapp_example_service/add_two_integers ```</p>
<p>and immediately press tab twice in order to auto complete the service requirements. Please assign values on the parameters a and b and in the username put 'rapp' and hit enter. Voila! You can see the result in the additionResult parameter and you can see the username of the user rapp in the userOntologyAlias parameter. In case you use a different username which does not exist, the field will return blank, ''.</p>
<h3>Create a ROS test for the service</h3>
<p>Now we will create a ROS test that will perform a test to ensure our service is working correctly. The first thing to do is edit the <code>CMakeLists.txt</code> of the rapp_example_service package, to incorporate the testing dependencies. The file located at</p>
<p>``` ~/rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_example_service/CMakeLists.txt ```</p>
<p>must now contain the following content:</p>
<p>```cmake cmake_minimum_required(VERSION 2.8.3) project(rapp_example_service)</p>
<h2>Find catkin macros and libraries</h2>
<h2>if COMPONENTS list like find_package(catkin REQUIRED COMPONENTS xyz)</h2>
<h2>is used, also find other catkin packages</h2>
<p>find_package(catkin REQUIRED COMPONENTS rapp_platform_ros_communications rospy std_msgs rostest )</p>
<h6></h6>
<h2>catkin specific configuration</h2>
<h6></h6>
<p>catkin_package( CATKIN_DEPENDS rospy std_msgs rostest rapp_platform_ros_communications INCLUDE_DIRS )</p>
<h6></h6>
<h2>Build</h2>
<h6></h6>
<p>include_directories( ${catkin_INCLUDE_DIRS} )</p>
<h6></h6>
<h2>Build</h2>
<h6></h6>
<p>if (CATKIN_ENABLE_TESTING) #catkin_add_nosetests(tests/cognitive_exercise_system_services_functional_tests.py) add_rostest(tests/example_service_tests.launch) endif() ```</p>
<p>As you can see we have added rostest in the dependencies and enabled testing. Similarly, the file located at</p>
<p>``` ~/rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_example_service/package.xml ```</p>
<p>must be updated in order to contain the following:</p>
<p>```xml &lt;?xml version="1.0"?&gt; &lt;package&gt; &lt;name&gt;rapp_example_service&lt;/name&gt; &lt;version&gt;0.0.0&lt;/version&gt; The rapp_example_service package</p>
<p>&lt;maintainer email="thanos@todo.todo"&gt;thanos&lt;/maintainer&gt;</p>
<p>&lt;license&gt;TODO&lt;/license&gt;</p>
<p>&lt;buildtool_depend&gt;catkin&lt;/buildtool_depend&gt; &lt;build_depend&gt;rapp_platform_ros_communications&lt;/build_depend&gt; &lt;build_depend&gt;rospy&lt;/build_depend&gt; &lt;build_depend&gt;std_msgs&lt;/build_depend&gt; &lt;run_depend&gt;rapp_platform_ros_communications&lt;/run_depend&gt; &lt;run_depend&gt;rospy&lt;/run_depend&gt; &lt;run_depend&gt;std_msgs&lt;/run_depend&gt; &lt;run_depend&gt;rostest&lt;/run_depend&gt; &lt;build_depend&gt;rostest&lt;/build_depend&gt;</p>
<p>&lt;export&gt;</p>
<p>&lt;/export&gt; &lt;/package&gt; ```</p>
<p>We have added the rostest run and build dependencies. Now we can proceed to creating the test source files. Navigate into the package folder and create the necessary files:</p>
<p>```bash cd /rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_example_service mkdir tests touch example_service_tests.launch touch example_service_tests.py ```</p>
<p>The content of the <code>example_service_tests.launch</code> file is:</p>
<p>```xml &lt;launch&gt;    &lt;test time-limit="100" test-name="rapp_example_service_tests" pkg="rapp_example_service" type="example_service_tests.py"&gt; &lt;/launch&gt; ```</p>
<p>The launch file declares the other ROS node dependencies and the source file of tests to run. The content of the <code>example_service_tests.py</code> file is:</p>
<p>```python #!/usr/bin/env python</p>
<p>#Copyright 2015 RAPP</p>
<p>PKG='rapp_example_service'</p>
<p>import sys import unittest import rospy import roslib</p>
<p>from rapp_platform_ros_communications.srv import ( tutorialExampleServiceSrv, tutorialExampleServiceSrvRequest, tutorialExampleServiceSrvResponse)</p>
<p>class ExampleServiceTests(unittest.TestCase): </p>
<pre class="fragment">def test_example_service_basic(self):
    ros_service = rospy.get_param("rapp_example_service_topic")
    rospy.wait_for_service(ros_service)

    test_service = rospy.ServiceProxy(ros_service, tutorialExampleServiceSrv)

    req = tutorialExampleServiceSrvRequest()
    req.a=10
    req.b=25
    req.username="rapp"
    response = test_service(req)
    self.assertEqual(response.userOntologyAlias, "Person_DpphmPqg")
    self.assertEqual(response.additionResult, 35)
</pre><h2>The main function. Initializes the Cognitive Exercise System functional tests</h2>
<p>if <b>name</b> == '<b>main</b>': import rosunit rosunit.unitrun(PKG, 'ExampleServiceTests', ExampleServiceTests) ```</p>
<p>We have created a python unit test, where the input is checked against the expected output in order to validate the results and consequently that the service is working correctly. The last thing to do now is to perform the test. Please first recompile the project:</p>
<p>```bash $ cd /rapp_platform/rapp-platform-catkin-ws/ $ rm -rf ./build ./devel $ catkin_make ```</p>
<p>And now, in order to launch the test run the command:</p>
<p>```bash $ cd /rapp_platform/rapp-platform-catkin-ws/ $ catkin_make run_tests_rapp_example_service ```</p>
<p>The result should be that 1 test executed successfully.</p>
<h2>Section 2: Create the HOP web service</h2>
<p>Read on <a href="https://github.com/rapp-project/rapp-platform/wiki/How-to-create-a-HOP-service-for-a-ROS-service%3F">How-to-create-a-HOP-service-for-a-ROS-service</a>, if you have not done so already.</p>
<p>Also, this web service implementation requires to have previously read on the <a href="https://github.com/rapp-project/rapp-platform/wiki/A-full-RAPP-Platform-service-creation-example#section-2-create-the-hop-web-service">simple-example</a>. The steps are the same, with a difference in the Web Service onrequest callback implementation.</p>
<p>Follow the steps described <a href="https://github.com/rapp-project/rapp-platform/wiki/A-full-RAPP-Platform-service-creation-example#section-2-create-the-hop-web-service">here</a> to create the respective directories and source files.</p>
<p>The Web-Service response message includes the <code>sum_result</code> and <code>error</code> properties. The ROS Service request message has two integer properties, <code>a</code> and <code>b</code> and the <code>username</code> value.</p>
<p>```js var clientRes = function(sum_result, user_ontology_alias, error) { sum_result = sum_result || 0; error = error || ''; user_ontology_alias = user_ontology_alias || '' return { sum_result: sum_result, user_ontology_alias: user_ontology_alias, error: error } }</p>
<p>var rosReqMsg = function(a, b, username) { a = a || 0; b = b || 0; username = username || ''; return { a: a, b: b, username: username } } ```</p>
<p>The rapp_example_service ROS Service url path is <code>/rapp/rapp_example_service/add_two_integers</code></p>
<p>```js var rosSrvUrlPath = "/rapp/rapp_example_service/add_two_integers" ```</p>
<p>Next you need to implement the WebService <b>onrequest</b> callback function. This is the function that will be called as long as a request for the rapp_example_web_service arrives.</p>
<p>A question comes. How will we obtain the <code>username</code> value to be passed to the ROS Service? The easy way is for the clients to pass the <code>username</code> value on the request body, but this means that the RAPP Application Authentication mechanisms break. As explained <a href="https://github.com/rapp-project/rapp-platform/wiki/RAPP-Application-Authentication">here</a> and <a href="https://github.com/rapp-project/rapp-platform/wiki/How-to-create-a-HOP-service-for-a-ROS-service%3F#rapp-web-services-framework">here</a>, the <b>username</b> of the client can be found in <code>username</code> property of the <code>req</code> object, <code>req.username</code>, after authentication of the incoming client request.</p>
<p>Below is the implementation of the respective Web Service onrequest callback.</p>
<p>```js function svcImpl(req, resp, ros) { // Get values of 'a' and 'b' from request body. var numA = req.body.a; var numB = req.body.b; var username = req.username;</p>
<p>// Create the rosMsg var rosMsg = new rosReqMsg(numA, numB, username);</p>
<p>/***</p>
<ul>
<li>ROS-Service response callback.</li>
</ul>
<p>function callback(rosResponse){ // Get the sum result value from ROS Service response message. var response = clientRes( rosResponse.additionResult, rosResponse.userOntologyAlias ); // Return the sum result, of numbers 'a' and 'b', and the <code>user_ontology_alias</code> to the client. resp.sendJson(response); }</p>
<p>/***</p>
<ul>
<li>ROS-Service onerror callback.</li>
</ul>
<p>function onerror(e){ // Respond a "Server Error". HTTP Error 501 - Internal Server Error resp.sendServerError(); }</p>
<p>/***</p>
<ul>
<li>Call ROS-Service.</li>
</ul>
<p>ros.callService(rosSrvUrlPath, rosMsg, {success: callback, fail: onerror}); } ```</p>
<p>Export the service onrequest callback function (svcImpl):</p>
<p>```js module.exports = svcImpl; ```</p>
<p>Add the <code>rapp_example_web_service</code> entry in <a href="https://github.com/rapp-project/rapp-platform/blob/master/rapp_web_services/config/services/services.json">services.json</a> file:</p>
<p>```json "rapp_example_web_service": { "launch": true, "anonymous": false, "name": "rapp_example_web_service", "url_name": "add_two_ints", "namespace": "", "ros_connection": true, "timeout": 45000 } ```</p>
<p>The Web Service will listen at <code><a href="http://localhost:9001/hop/add_two_ints">http://localhost:9001/hop/add_two_ints</a></code> as defined by the <code>url_name</code> value.</p>
<p>You can set the url path for the Web Service to be <code>rapp_example_web_service/add_two_ints</code> by setting the url_name and namespace respectively:</p>
<p>```json "rapp_example_web_service": { "launch": true, "anonymous": false, "name": "rapp_example_web_service", "url_name": "add_two_ints", "namespace": "rapp_example_web_service", "ros_connection": true, "timeout": 45000 } ```</p>
<p>We have also set this Web Service to timeout after 45 seconds (<code>timeout</code>). This is critical when WebService-to-ROS communcation bridge breaks!</p>
<p>For simplicity, we will configure this WebService to be launched under an already existed Web Worker thread (<b>main-1</b>).</p>
<p>The <a href="https://github.com/rapp-project/rapp-platform/blob/master/rapp_web_services/config/services/workers.json">workers.json</a> file contains Web Workers entries. Add the <code>rapp_example_web_service</code> service under the <code>main-1</code> worker:</p>
<p>```json "main-1": { "launch": true, "path": "workers/main1.js", "services": [ ... "rapp_example_web_service" ] } ```</p>
<p>The newly implemented <code>rapp_example_web_service</code> Web Service is ready to be launched. Launch the RAPP Platform Web Server:</p>
<p>```bash $ cd ~/rapp_platform/rapp-platform-catkin-ws/src/rapp-platform/rapp_web_services $ pm2 start server.yaml ```</p>
<p>If you dont want to launch the Web Server using pm2 process manager, just execute the <code>run.sh</code> script in the same directory:</p>
<p>```bash $ ./run.sh ```</p>
<p>You will notice the following output from the logs:</p>
<p>```bash info: [] Registered worker service {<a href="http://localhost:9001/hop/add_two_ints">http://localhost:9001/hop/add_two_ints</a>} under worker thread {main-1} info: [] { worker: 'main-1', path: '/hop/add_two_ints', url: '<a href="http://localhost:9001/hop/add_two_ints',">http://localhost:9001/hop/add_two_ints',</a> frame: [Function] } ```</p>
<p>All set! The RAPP Platform accepts requests for the <code>rapp_example_web_service</code> at <code><a href="http://rapp-platform-local:9001/hop/add_two_ints">http://rapp-platform-local:9001/hop/add_two_ints</a></code></p>
<p>You can test it using <code>curl</code> from commandline:</p>
<p>```bash $ curl &ndash;data "a=100&amp;b=20" <a href="http://localhost:9001/hop/add_two_ints">http://localhost:9001/hop/add_two_ints</a> ```</p>
<p>Notice that the RAPP Platform will return <code>Authentication Failure</code> (HTTP 401 Unauthorized Error). This is because the RAPP Platform uses token-based application authentication mechanisms to authenticate incoming client requests. You will have to pass a valid token to the <b>request headers</b>. By default, the RAPP Platform database includes a user <code>rapp</code> and the token is <b>rapp_token</b>. Pass that token value to the <code>Accept-Token</code> field of the request header:</p>
<p>```bash $ curl -H "Accept-Token: rapp_token" &ndash;data "a=100&amp;b=20" <a href="http://localhost:9001/hop/add_two_ints">http://localhost:9001/hop/add_two_ints</a> ```</p>
<p>The output should now be similar to:</p>
<p>```bash {sum_result: 120, user_ontology_alias: "THE_USER_ONTOLOGY_ALIAS", error: ""} ```</p>
<h2>Section 3: Update the RAPP Platform API</h2>
<p>First, read on <a href="https://github.com/rapp-project/rapp-platform/wiki/How-to-write-the-API-for-a-HOP-service%3F">How to write the API for a HOP service</a>, if you have not done so already.</p>
<p>The AddTwoInts Cloud Message class is identical to the <b>simple-example</b> presented <a href="https://github.com/rapp-project/rapp-platform/wiki/A-full-RAPP-Platform-service-creation-example#section-3-update-the-rapp-platform-api">here</a>, with the addition of <code>user_ontology_alias</code> property to the <code>AddTwoInts.Response</code> class:</p>
<p>```python from RappCloud.Objects import ( File, Payload)</p>
<p>from Cloud import ( CloudMsg, CloudRequest, CloudResponse)</p>
<p>class AddTwoInts(CloudMsg): """ Add Two Integers Exqample CloudMsg object"""</p>
<p>class Request(CloudRequest): """ Add Two Integers Cloud Request object. AddTwoInts.Request """ def <b>init</b>(self, **kwargs): """! Constructor </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">**kwargs</td><td>- Keyword arguments. Apply values to the request attributes.<ul>
<li>a</li>
<li>b"</li>
</ul>
</td></tr>
  </table>
  </dd>
</dl>
<h2>Number #1</h2>
<p>self.a = 0 </p>
<h2>Number #2</h2>
<p>self.b = 0 </p>
<h1>Apply passed keyword arguments to the Request object.</h1>
<p>super(AddTwoInts.Request, self).__init__(**kwargs)</p>
<pre class="fragment">    def make_payload(self):
        """ Create and return the Payload of the Request. """
        return Payload(a=self.a, b=self.b)

    def make_files(self):
        """ Create and return Array of File objects of the Request. """
        return []

    class Response(CloudResponse):
        """ Add Two Integers Cloud Response object. AddTwoInts.Response """
        def __init__(self, **kwargs):
            """!
            Constructor

            @param **kwargs - Keyword arguments. Apply values to the request attributes.
            - @ref error
            - @ref sum_result
            """
            ## Error message
            self.error = ''
            ## The sum result of numbers a and b
            self.sum_result = 0
            ## User's ontology alias
            self.user_ontology_alias
            ## Apply passed keyword arguments to the Request object.
            super(AddTwoInts.Response, self).__init__(**kwargs)


    def __init__(self, **kwargs):
        """!
        Constructor

        @param **kwargs - Keyword arguments. Apply values to the request attributes.
            - @ref Request.a
            - @ref Request.b
        """

        # Create and hold the Request object for this CloudMsg
        self.req = AddTwoInts.Request()
        # Create and hold the Response object for this CloudMsg
        self.resp = AddTwoInts.Response()
        super(AddTwoInts, self).__init__(svcname='add_two_ints', **kwargs)
</pre><p>```</p>
<p>Similar to the simple-example, append the following line of code in the <code>RappCloud/CloudMsgs/__init__.py</code> file:</p>
<p>```python from AddTwoInts import AddTwoInts ```</p>
<p>Now everything is in place to call the newly created RAPP Platform Service, using the python implementation of the rapp-platform-api. An example is presented below:</p>
<p>```python from RappCloud.CloudMsgs import AddTwoInts from RappCloud import RappPlatformService</p>
<p>svcClient = RappPlatformService(persistent=True, timeout=1000) msg = AddTwoInts(a=5, b=4)</p>
<p>response svcClient.call(msg)</p>
<p>print response.sum_result </p>
<blockquote class="doxtable">
<blockquote class="doxtable">
<p>9</p>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p>print response.user_ontology_alias </p>
<blockquote class="doxtable">
<blockquote class="doxtable">
<p>"THE_USER_ONTOLOGY_ALIAS"</p>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p>``` </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Fri Jul 1 2016 18:18:55 for RAPP Platform Wiki by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
