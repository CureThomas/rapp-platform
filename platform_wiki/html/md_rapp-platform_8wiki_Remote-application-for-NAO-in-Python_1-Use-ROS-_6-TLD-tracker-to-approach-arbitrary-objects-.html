<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>RAPP Platform Wiki: (hard) Remote-application-for-NAO-in-Python:-Use-ROS-&amp;-TLD-tracker-to-approach-arbitrary-objects-(hard)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="RAPP_logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">RAPP Platform Wiki
   &#160;<span id="projectnumber">v0.6.0</span>
   </div>
   <div id="projectbrief">RAPP Platform is a collection of ROS nodes and back-end processes that aim to deliver ready-to-use generic services to robots</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_rapp-platform_8wiki_Remote-application-for-NAO-in-Python_1-Use-ROS-_6-TLD-tracker-to-approach-arbitrary-objects-.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">(hard) Remote-application-for-NAO-in-Python:-Use-ROS-&amp;-TLD-tracker-to-approach-arbitrary-objects-(hard) </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>In the current tutorial we will showcase the way to create a more complex application which utilizes external (out of RAPP) packages. This application will be create as a ROS node, in order to take advantage of other ROS packages.</p>
<p>In this application we will track an object using the NAO front camera and the <a href="https://github.com/pandora-auth-ros-pkg/open_tld">OpenTLD</a> algorithm, as well as <a href="https://github.com/pandora-auth-ros-pkg/pandora_tld">its wrapper</a> used in the <a href="http://pandora.ee.auth.gr/">PANDORA robotics team</a>.</p>
<p>Thus for this tutorial we will need:</p>
<ul>
<li>A real NAO robot</li>
<li>the NaoQi Python libraries</li>
<li>the rapp-robots-api GitHub repository</li>
<li>the OpenTLD GitHub repository</li>
<li>the PANDORA OpenTLD wrapper</li>
<li>ROS Indigo installed</li>
<li>ROS packages for NaoQi</li>
</ul>
<p>This application's code can be found <a href="https://github.com/rapp-project/rapps-nao/tree/master/3.track_object_TLD/tld_tracker_nao">here</a> in the form of a ROS package.</p>
<h2>Preparation</h2>
<h4>Setup the NaoQi Python libraries</h4>
<p>Check <a href="https://github.com/rapp-project/rapp-platform/wiki/Create-a-remote-robotic-application-for-NAO-in-Python-(novice">here</a>#naoqi-python-libraries-setup) for details.</p>
<h3>Setup the RAPP Robots Python API</h3>
<p>Check <a href="https://github.com/rapp-project/rapp-platform/wiki/Create-a-remote-robotic-application-for-NAO-in-Python-(novice">here</a>#rapp-robots-api-libraries-setup) for details.</p>
<h4>Install ROS Indigo and ROS packages for NaoQi</h4>
<p>The installation procedure can be found <a href="http://wiki.ros.org/indigo/Installation/Ubuntu">here</a> for the Ubuntu 14.04 distribution.</p>
<p>After ROS installation, install the NaoQi ROS packages by:</p>
<p>```bash sudo apt-get install ros-indigo-naoqi-* sudo apt-get install ros-indigo-nao-bringup ros-indigo-nao-apps ros-indigo-usb-cam ```</p>
<h4>Setup OpenTLD and PANDORA TLD ROS packages</h4>
<p>Initially, a <code>catkin_repository</code> must be created and the ROS packages cloned in it:</p>
<p>```bash </p>
<h1>Create the proper folders</h1>
<p>mkdir -p ~/rapp_nao/rapps &amp;&amp; cd ~/rapp_nao/rapps mkdir -p rapp_catkin_ws/src &amp;&amp; cd rapp_catkin_ws/src </p>
<h1>Initialize the Catkin workspace</h1>
<p>catkin_init_workspace </p>
<h1>Clone the OpenTLD and PANDORA TLD packages</h1>
<p>git clone <a href="https://github.com/pandora-auth-ros-pkg/pandora_tld.git">https://github.com/pandora-auth-ros-pkg/pandora_tld.git</a> git clone <a href="https://github.com/pandora-auth-ros-pkg/open_tld.git">https://github.com/pandora-auth-ros-pkg/open_tld.git</a> </p>
<h1>Build the packages</h1>
<p>cd ~/rapp_nao/rapps/rapp_catkin_ws &amp;&amp; catkin_make -j1 </p>
<h1>Export the proper environmental variables</h1>
<p>echo 'source ~/rapp_nao/rapps/rapp_catkin_ws/devel/setup.bash &ndash;extend' &gt;&gt; ~/.bashrc source ~/.bashrc ```</p>
<p>Next, you must change the input image topic to TLD in order to bind the callback from the NAO camera. The <code>~/rapp_nao/rapps/rapp_catkin_ws/src/pandora_tld/config/predator_topics.yaml</code> must include the following:</p>
<p>```yaml predator_alert : /vision/predator_alert input_image_topic: /nao_robot/camera/top/camera/image_raw begin_hunt_topic: /predator/hunt ``` </p>
<h2>Creating the application</h2>
<p>Initially a ROS package must be created that will facilitate the code. The package will have <code>rospy</code> as dependency and will be named <code>tld_tracker_nao</code>:</p>
<p>```bash cd ~/rapp_nao/rapps/rapp_catkin_ws/src catkin_create_pkg tld_tracker_nao rospy geometry_msgs sensor_msgs std_msgs mkdir -p tld_tracker_nao/scripts touch tld_tracker_nao/scripts/tracker.py chmod +x tld_tracker_nao/scripts/tracker.py ```</p>
<p>The contents of <code>tracker.py</code> follow:</p>
<p>```python #!/usr/bin/env python</p>
<h1>Authors:</h1>
<h1>Chrisa Gouniotou (<a href="https://github.com/chrisagou">https://github.com/chrisagou</a>)</h1>
<h1>Aspa Karanasiou (<a href="https://github.com/aspa1">https://github.com/aspa1</a>)</h1>
<h1>Manos Tsardoulias (<a href="https://github.com/etsardou">https://github.com/etsardou</a>)</h1>
<h1>Import the RAPP Robot API</h1>
<p>from rapp_robot_api import RappRobot</p>
<p>from geometry_msgs.msg import Polygon from geometry_msgs.msg import Twist</p>
<p>from naoqi_bridge_msgs.msg import JointAnglesWithSpeed</p>
<p>import rospy import sys import time</p>
<p>class NaoTldTracker: </p>
<pre class="fragment">def __init__(self):
    self.rh = RappRobot()

    # Use naoqi_brdge to move the head
    self.joint_pub = rospy.Publisher('/joint_angles', JointAnglesWithSpeed, queue_size=1)

    # NAO stands up
    self.rh.motion.enableMotors()
    self.rh.humanoid_motion.goToPosture("Stand", 0.7)

    self.lost_object_counter = 20
    self.lock_motion = False
    self.hunt_initiated = False

    # These are the NAO body velocities. They are automatically published
    # in the self.set_velocities_callback
    self.x_vel = 0
    self.y_vel = 0
    self.theta_vel = 0

    # Subscription to the TLD tracking alerts
    self.predator_sub = rospy.Subscriber("/vision/predator_alert", \
            Polygon, self.track_bounding_box)

    # Timer callback to check if tracking has been lost
    rospy.Timer(rospy.Duration(0.1), self.lost_object_callback)
    # Callback to set the velocities periodically
    rospy.Timer(rospy.Duration(0.1), self.set_velocities_callback)

# Callback of the TLD tracker. Called when the object has been detected
def track_bounding_box(self, polygon):
    self.hunt_initiated = True

    # Set the timeout counter to 2 seconds
    self.lost_object_counter = 20

    # Velocities message initialization
    joint = JointAnglesWithSpeed()
    joint.joint_names.append("HeadYaw")
    joint.joint_names.append("HeadPitch")
    joint.speed = 0.1
    joint.relative = True

    # Get center of detected object and calculate the head turns
    target_x = polygon.points[0].x + 0.5 * polygon.points[1].x
    target_y = polygon.points[0].y + 0.5 * polygon.points[1].y

    sub_x = target_x - 320 / 2.0
    sub_y = target_y - 240 / 2.0

    var_x = (sub_x / 160.0)
    var_y = (sub_y / 120.0)

    joint.joint_angles.append(-var_x * 0.05)
    joint.joint_angles.append(var_y * 0.05)

    ans = self.rh.humanoid_motion.getJointAngles(['HeadYaw', 'HeadPitch'])
    head_pitch = ans['angles'][1]
    head_yaw = ans['angles'][0]

    # Get the sonar measurements
    sonars = self.rh.sensors.getSonarsMeasurements()

    # Check if NAO is close to an obstacle
    if sonars['sonars']['front_left'] &lt;= 0.3 or sonars['sonars']['front_right'] &lt;= 0.3:
        self.lock_motion = True
        rospy.loginfo("Locked due to sonars")
    # Check if NAOs head looks way too down or up
    elif head_pitch &gt;= 0.4 or head_pitch &lt;= -0.4:
        self.lock_motion = True
        rospy.loginfo("Locked due to head pitch")
    # Else approach the object
    elif self.lock_motion is False:
        self.theta_vel = head_yaw * 0.1
        if -0.2 &lt; head_yaw &lt; 0.2:
            print "Approaching"
            self.x_vel = 0.5
            self.y_vel = 0.0
        else:
            self.x_vel = 0.0
            self.y_vel = 0.0
            print "Centering"
        self.joint_pub.publish(joint)

    # Check the battery levels
    batt = self.rh.sensors.getBatteryLevels()
    battery = batt['levels'][0]
    if battery &lt; 25:
        self.rh.audio.setVolume(100)
        self.rh.audio.speak("My battery is low")
        self.predator_sub.unregister()
        self.rh.humanoid_motion.goToPosture("Sit", 0.7)
        self.rh.motion.disableMotors()
        sys.exit(1)

# Callback invoked every 0.1 seconds to check for lost of object tracking
def lost_object_callback(self, event):
    # Continues only after the user has selected an object
    if self.hunt_initiated:
        self.lost_object_counter -= 1
        # If 2 seconds have passed without tracking activity the robot stops
        if self.lost_object_counter &lt; 0:
            self.lock_motion = True
            self.x_vel = 0.0
            self.y_vel = 0.0
            self.theta_vel = 0.0
            rospy.loginfo("Locked due to 2 seconds of non-tracking")

            self.predator_sub.unregister()

# Callback to periodically (0.1 sec) set velocities, except from the 
# case where the robot has locked its motion
def set_velocities_callback(self, event):
    if not self.lock_motion:
        self.rh.motion.moveByVelocity(self.x_vel, self.y_vel, \
                self.theta_vel)
    else:
        self.rh.motion.moveByVelocity(0, 0, 0)
</pre><h1>The main function</h1>
<p>if <b>name</b> == "__main__": rospy.init_node('nao_tld_tracker', anonymous = True) nao = NaoTldTracker() rospy.spin() ```</p>
<p>The next step is to create a ROS launcher to deploy the node:</p>
<p>```bash cd ~/rapp_nao/rapps/rapp_catkin_ws/src/tld_tracker_nao/ mkdir launch &amp;&amp; cd launch touch tld_tracker_nao.launch ```</p>
<p>The <code>tld_tracker_nao.launch</code> must contain:</p>
<p>```xml &lt;launch&gt;</p>
<p>&lt;arg name="nao_ip" value="$(arg nao_ip)"&gt; </p>
<p>&lt;node name="nao_tld_tracker_node" type="tracker.py" pkg="tld_tracker_nao" output="screen"&gt; &lt;/launch&gt; ```</p>
<p>Furthermore, we need another launch file called <code>nao_bringup.launch</code>. First we create it:</p>
<p>```bash cd ~/rapp_nao/rapps/rapp_catkin_ws/src/tld_tracker_nao/launch touch nao_bringup.launch ```</p>
<p>And then we fill it with:</p>
<p>```xml &lt;launch&gt;</p>
<p>&lt;arg name="nao_ip"&gt; &lt;arg name="nao_port" default="$(optenv NAO_PORT 9559)"&gt;</p>
<p>&lt;node pkg="diagnostic_aggregator" type="aggregator_node" name="diag_agg" clear_params="true"&gt; &lt;rosparam command="load" file="$(find nao_bringup)/config/nao_analysers.yaml"&gt; &lt;/node&gt;</p>
<p>&lt;arg name="version" value="V40"&gt; </p>
<p>&lt;arg name="nao_ip" value="$(arg nao_ip)"&gt; </p>
<p>&lt;arg name="nao_ip" value="$(arg nao_ip)"&gt; </p>
<p>&lt;arg name="nao_ip" value="$(arg nao_ip)"&gt; &lt;arg name="nao_port" value="$(arg nao_port)"&gt; </p>
<p>&lt;arg name="nao_ip" value="$(arg nao_ip)"&gt; &lt;arg name="resolution" value="1"&gt;   &lt;arg name="nao_ip" value="$(arg nao_ip)"&gt; &lt;arg name="source" value="1"&gt; </p>
<p>&lt;arg name="nao_ip" value="$(arg nao_ip)"&gt; &lt;arg name="memory_key" value="Device/SubDeviceList/US/Left/Sensor/Value"&gt; &lt;arg name="frame_id" value="LSonar_frame"&gt;   &lt;arg name="nao_ip" value="$(arg nao_ip)"&gt; &lt;arg name="memory_key" value="Device/SubDeviceList/US/Right/Sensor/Value"&gt; &lt;arg name="frame_id" value="RSonar_frame"&gt; </p>
<p>&lt;arg name="nao_ip" value="$(arg nao_ip)"&gt; </p>
<p>&lt;/launch&gt; ```</p>
<p>Finally, the application can be launched by:</p>
<p>```bash roslaunch tld_tracker_nao tld_tracker_nao.launch ```</p>
<p>If everything is correct, a TLD window must be raised, showing live the stream from the NAO front camera. Click on this window, press <code>r</code> and select a rectangle with your mouse for the NAO to track. Have in mind that the object-to-track must have sufficient features for the TLD to succeed (e.g. a white wall won't work).</p>
<p>Then, NAO should center the object with its head and start moving towards there. There are four reasons for NAO to stop:</p>
<ul>
<li>To loose tracking for 2 seconds</li>
<li>To have a sonar measurement under 30 cm</li>
<li>For the head pitch angle to be larger than 0.4 rad or smaller than -0.4 rad (the object is on the floor or very high)</li>
<li>The battery level to be under 25%</li>
</ul>
<p>Below you can see an example where NAO tracks an orange!</p>
<div class="image">
<img src="https://raw.githubusercontent.com/wiki/rapp-project/rapp-platform/images/orange_track.gif" />
</div>
 </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Jul 19 2016 11:43:36 for RAPP Platform Wiki by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
